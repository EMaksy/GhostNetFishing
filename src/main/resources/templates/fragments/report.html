<div xmlns:th="http://www.thymeleaf.org"
     th:fragment="report"
     class="col-lg-3 col-md-6">

  <div class="card h-100 shadow-sm rounded-4">
    <div class="card-header">
      <a class="text-decoration-none text-reset d-block fw-semibold" th:href="@{/report}">
        Report a Ghost Net
      </a>
    </div>

    <div class="card-body">
      <!-- Bind the form DTO -->
      <form th:action="@{${formAction}}" th:object="${reportForm}" method="post" novalidate>
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

        <div class="mb-2">
          <label class="form-label small">Latitude*</label>
          <input id="lat-input" class="form-control rounded-3" th:field="*{latitude}" type="number" step="0.0001" min="-90" max="90" placeholder="52.5200" required/>
          <div class="text-danger small"
               th:if="${#fields.hasErrors('latitude')}"
               th:errors="*{latitude}">Latitude is required</div>
          <div class="form-text small text-muted">Use decimal degrees, between -90 and 90.</div>
        </div>
        <div class="mb-2">
          <label class="form-label small">Longitude*</label>
          <input id="lon-input" class="form-control rounded-3" th:field="*{longitude}" type="number" step="0.0001" min="-180" max="180" placeholder="13.4050" required/>
          <div class="text-danger small"
               th:if="${#fields.hasErrors('longitude')}"
               th:errors="*{longitude}">Longitude is required</div>
          <div class="form-text small text-muted">Use decimal degrees, between -180 and 180.</div>
        </div>

        <div class="mb-3">
          <label class="form-label small">Pick on map (click to set coordinates)</label>
          <link rel="stylesheet" th:href="@{/webjars/leaflet/1.9.4/dist/leaflet.css}" />
          <div id="report-map" style="height:320px; background:#e0e0e0; border-radius:0.5rem;"></div>
          <script th:src="@{/webjars/leaflet/1.9.4/dist/leaflet.js}"></script>
          <script>
            (function() {
              const latEl = document.getElementById('lat-input');
              const lonEl = document.getElementById('lon-input');
              if (!latEl || !lonEl) return;
              document.addEventListener('DOMContentLoaded', function() {
                if (!window.L) return;
                const map = L.map('report-map').setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  maxZoom: 18,
                  attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                let marker = null;
                function updateMarker(lat, lon) {
                  if (marker) { marker.remove(); }
                  marker = L.marker([lat, lon]).addTo(map);
                  map.setView([lat, lon], 6);
                }
                map.on('click', function(e) {
                  const lat = e.latlng.lat.toFixed(6);
                  const lon = e.latlng.lng.toFixed(6);
                  latEl.value = lat;
                  lonEl.value = lon;
                  updateMarker(lat, lon);
                });
                // initialize marker if values present
                const initLat = parseFloat(latEl.value);
                const initLon = parseFloat(lonEl.value);
                if (!isNaN(initLat) && !isNaN(initLon)) {
                  updateMarker(initLat, initLon);
                }
              });
            })();
          </script>
        </div>
        <div class="mb-2">
          <label class="form-label small">Estimated Size*</label>
          <select class="form-select rounded-3" th:field="*{size}" required>
            <option value="SMALL">Small ≤ 25m</option>
            <option value="MEDIUM">Medium ≤ 50m</option>
            <option value="LARGE">Large > 50m</option>
          </select>
          <div class="text-danger small"
               th:if="${#fields.hasErrors('size')}"
               th:errors="*{size}">Size is required</div>
        </div>
        <div class="mb-2">
          <label class="form-label small">Your Name*</label>
          <input class="form-control rounded-3" th:field="*{name}" required/>
          <div class="text-danger small"
               th:if="${#fields.hasErrors('name')}"
               th:errors="*{name}">Name is required</div>
        </div>
        <div class="mb-2">
          <label class="form-label small">Phone Number (optional if anonymous)</label>
          <input class="form-control rounded-3" th:field="*{phone}"/>
          <div class="text-danger small"
               th:if="${#fields.hasErrors('phone')}"
               th:errors="*{phone}">Phone number is required when not reporting anonymously</div>
        </div>
        <div class="form-check mb-2">
          <label class="form-check-label small">Report anonymously</label>
          <input class="form-check-input" type="checkbox" value="true" th:field="*{anonymous}"/>
        </div>
        <button class="btn btn-primary w-100 rounded-3 fw-semibold mt-2" type="submit">
          Submit Report
        </button>

      </form>
    </div>
  </div>
</div>
